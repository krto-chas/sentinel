<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sentinel Upload API</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <div class="grid"></div>
    <div class="glow"></div>

    <header>
      <div class="nav">
        <div class="brand">
          <img src="/static/assets/sidestep-logo.png" alt="Sidestep Error logo" />
          <div>
            <div>Sentinel Upload API</div>
            <small>Secure DevSecOps Demo</small>
          </div>
        </div>
        <div class="pill">build → scan → deploy</div>
      </div>
    </header>

    <main>
      <section class="hero">
        <div>
          <h1>Secure Uploads, Zero Guesswork</h1>
          <p>
            A hardened file intake pipeline built for DevSecOps. Validate types,
            enforce policy, and ship with confidence.
          </p>
          <div class="cta">
            <a class="button" href="#project-docs">Uploaded Files</a>
            <a class="button" href="#upload">Test Upload</a>
            <a
              class="button"
              href="https://github.com/Sidestep-Error/sentinel-upload-api/issues/new/choose"
              target="_blank"
              rel="noopener noreferrer"
              >Report Bug</a
            >
          </div>
        </div>
        <div class="panel">
          <img
            class="logo-hero"
            src="/static/assets/sidestep-logo.png"
            alt="Sidestep Error mark"
          />
        </div>
      </section>

      <section id="auth" class="panel upload">
        <h2>Auth Console</h2>
        <div class="auth-grid">
          <input id="auth-email" type="email" placeholder="Email" />
          <input id="auth-password" type="password" placeholder="Password" />
        </div>
        <div class="cta">
          <button class="button" id="register-btn" type="button">Create account</button>
          <button class="button" id="login-btn" type="button">Login</button>
          <button class="button" id="logout-btn" type="button">Logout</button>
        </div>
        <div class="status" id="auth-status">Not authenticated</div>
      </section>

      <section id="upload" class="panel upload">
        <h2>Upload Console</h2>
        <div class="dropzone" id="dropzone">
          <p>Drop a file here or click to choose</p>
          <label for="file-input">Choose file</label>
          <input id="file-input" type="file" />
        </div>
        <div class="meta">
          <div>Allowed types: PDF, PNG, JPG, TXT, MD, CSV, DOC(X), XLS(X), PPT(X), ODT, ODS, ODP</div>
          <div>Endpoint: <code>/upload</code></div>
        </div>
        <button class="button" id="upload-btn" type="button">Upload now</button>
        <div class="status" id="status">Waiting for input…</div>
      </section>

      <section id="project-docs" class="panel">
        <h2>Uploaded Files</h2>
        <p>Latest uploads stored in MongoDB.</p>
        <div class="list-header">
          <span>Filename</span>
          <span>Type</span>
          <span>Status</span>
        </div>
        <div class="list" id="uploads-list">
          <div class="list-item">Loading...</div>
        </div>
        <p class="meta">
          Developer API docs: <a href="/docs">/docs</a>
        </p>
        <p class="meta">
          Project docs: README.md, PLAN.md, SECURITY.md, docs/*, sre/*, runbooks/*
        </p>
      </section>

      <section class="cards">
        <div class="card">
          <h3>Policy Guarded</h3>
          <p>Trivy, SBOM, and gatekeeper checks enforce clean builds.</p>
        </div>
        <div class="card">
          <h3>Runtime Ready</h3>
          <p>Falco + runbooks for instant incident response.</p>
        </div>
        <div class="card">
          <h3>Observable</h3>
          <p>SLIs/SLOs track success rate and latency.</p>
        </div>
      </section>

      <footer>
        <p>Sentinel Upload API · NordTech AB · DevSecOps program</p>
      </footer>
    </main>

    <script>
      const dropzone = document.getElementById("dropzone");
      const input = document.getElementById("file-input");
      const uploadBtn = document.getElementById("upload-btn");
      const statusEl = document.getElementById("status");
      const emailInput = document.getElementById("auth-email");
      const passwordInput = document.getElementById("auth-password");
      const registerBtn = document.getElementById("register-btn");
      const loginBtn = document.getElementById("login-btn");
      const logoutBtn = document.getElementById("logout-btn");
      const authStatusEl = document.getElementById("auth-status");

      let firebaseIdToken = localStorage.getItem("firebaseIdToken") || "";
      let firebaseWebApiKey = "";
      let authMode = "off";

      function setStatus(message, type) {
        statusEl.textContent = message;
        statusEl.classList.remove("error", "warn");
        if (type) statusEl.classList.add(type);
      }

      function setAuthStatus(message, type) {
        authStatusEl.textContent = message;
        authStatusEl.classList.remove("error", "warn");
        if (type) authStatusEl.classList.add(type);
      }

      function requestHeaders() {
        const headers = {};
        if (firebaseIdToken) {
          headers.Authorization = `Bearer ${firebaseIdToken}`;
        }
        return headers;
      }

      async function firebaseAuthRequest(endpoint, body) {
        if (authMode !== "firebase") {
          throw new Error("Auth mode is not firebase");
        }
        if (!firebaseWebApiKey) {
          throw new Error("Missing Firebase Web API key in server config");
        }

        const response = await fetch(
          `https://identitytoolkit.googleapis.com/v1/${endpoint}?key=${firebaseWebApiKey}`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          }
        );
        const data = await response.json();
        if (!response.ok) {
          const firebaseError = data?.error?.message || "Firebase auth failed";
          throw new Error(firebaseError);
        }
        return data;
      }

      registerBtn.addEventListener("click", async () => {
        try {
          if (authMode !== "firebase") {
            throw new Error("Auth is disabled (AUTH_MODE=off)");
          }
          const email = emailInput.value.trim();
          const password = passwordInput.value;
          if (!email || !password) {
            throw new Error("Email and password required");
          }
          const data = await firebaseAuthRequest("accounts:signUp", {
            email,
            password,
            returnSecureToken: true,
          });
          firebaseIdToken = data.idToken;
          localStorage.setItem("firebaseIdToken", firebaseIdToken);
          setAuthStatus(`Authenticated as ${email}`);
          await loadUploads();
        } catch (error) {
          setAuthStatus(error.message, "error");
        }
      });

      loginBtn.addEventListener("click", async () => {
        try {
          if (authMode !== "firebase") {
            throw new Error("Auth is disabled (AUTH_MODE=off)");
          }
          const email = emailInput.value.trim();
          const password = passwordInput.value;
          if (!email || !password) {
            throw new Error("Email and password required");
          }
          const data = await firebaseAuthRequest("accounts:signInWithPassword", {
            email,
            password,
            returnSecureToken: true,
          });
          firebaseIdToken = data.idToken;
          localStorage.setItem("firebaseIdToken", firebaseIdToken);
          setAuthStatus(`Authenticated as ${email}`);
          await loadUploads();
        } catch (error) {
          setAuthStatus(error.message, "error");
        }
      });

      logoutBtn.addEventListener("click", async () => {
        firebaseIdToken = "";
        localStorage.removeItem("firebaseIdToken");
        setAuthStatus("Not authenticated");
        await loadUploads();
      });

      dropzone.addEventListener("dragover", (event) => {
        event.preventDefault();
        dropzone.classList.add("dragover");
      });

      dropzone.addEventListener("dragleave", () => {
        dropzone.classList.remove("dragover");
      });

      dropzone.addEventListener("drop", (event) => {
        event.preventDefault();
        dropzone.classList.remove("dragover");
        if (event.dataTransfer.files.length) {
          input.files = event.dataTransfer.files;
          setStatus(`Selected ${input.files[0].name}`);
        }
      });

      // Avoid double file-picker dialogs on browsers that already trigger via <label for>.
      dropzone.addEventListener("click", (event) => {
        const target = event.target;
        const isLabelOrInput =
          target instanceof HTMLElement &&
          (target.tagName === "LABEL" || target.tagName === "INPUT");
        if (isLabelOrInput) return;
        input.click();
      });

      // Allow selecting the same file again after a previous upload.
      input.addEventListener("click", () => {
        input.value = "";
      });
      input.addEventListener("change", () => {
        if (input.files.length) {
          setStatus(`Selected ${input.files[0].name}`);
        }
      });

      async function loadUploads() {
        try {
          const response = await fetch("/uploads", { headers: requestHeaders() });
          if (!response.ok) {
            if (response.status === 401) {
              throw new Error("Auth required");
            }
            throw new Error("Database unavailable");
          }
          const data = await response.json();
          const list = document.getElementById("uploads-list");
          list.innerHTML = "";
          if (!data.items.length) {
            list.innerHTML = '<div class="list-item">No uploads yet</div>';
            return;
          }
          data.items.forEach((item) => {
            const row = document.createElement("div");
            row.className = "list-item";
            const nameSpan = document.createElement("span");
            nameSpan.textContent = item.filename;
            const typeSpan = document.createElement("span");
            typeSpan.textContent = item.content_type;
            const statusSpan = document.createElement("span");
            statusSpan.textContent = item.status;
            row.appendChild(nameSpan);
            row.appendChild(typeSpan);
            row.appendChild(statusSpan);
            list.appendChild(row);
          });
        } catch (error) {
          const list = document.getElementById("uploads-list");
          list.innerHTML = `<div class="list-item">${error.message}</div>`;
        }
      }

      uploadBtn.addEventListener("click", async () => {
        if (!input.files.length) {
          setStatus("Choose a file first.", "warn");
          return;
        }

        const formData = new FormData();
        formData.append("file", input.files[0]);

        try {
          setStatus("Uploading...");
          const response = await fetch("/upload", {
            method: "POST",
            headers: requestHeaders(),
            body: formData,
          });
          const data = await response.json();
          if (!response.ok) {
            throw new Error(data.detail || "Upload failed");
          }
          setStatus(`Accepted: ${data.filename} (${data.content_type})`);
          await loadUploads();
        } catch (error) {
          setStatus(error.message, "error");
        }
      });

      async function initAuthConfig() {
        try {
          const response = await fetch("/auth/config");
          if (!response.ok) {
            throw new Error("Could not load auth config");
          }
          const config = await response.json();
          authMode = config.mode || "off";
          firebaseWebApiKey = config.firebase_web_api_key || "";
        } catch (error) {
          authMode = "off";
          firebaseWebApiKey = "";
        }

        if (authMode === "firebase") {
          setAuthStatus(firebaseIdToken ? "Token loaded from browser storage" : "Not authenticated");
        } else {
          setAuthStatus("Auth disabled (AUTH_MODE=off)");
        }
      }

      initAuthConfig().then(loadUploads);
    </script>
    <a
  class="bug-fab"
  href="https://github.com/Sidestep-Error/sentinel-upload-api/issues/new/choose"
  target="_blank"
  rel="noopener noreferrer"
  aria-label="Report a bug"
>
  Report bug
</a>

  </body>
</html>
