<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sentinel Upload API</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
    />
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <div class="grid"></div>
    <div class="glow"></div>

    <header>
      <div class="nav">
        <div class="brand">
          <img src="/static/assets/sidestep-logo.png" alt="Sidestep Error logo" />
          <div>
            <div>Sentinel Upload API</div>
            <small>Secure DevSecOps Demo</small>
          </div>
        </div>
        <div class="pill">build → scan → deploy</div>
      </div>
    </header>

    <main>
      <section class="hero">
        <div class="hero-copy panel">
          <h1>Secure Uploads, Zero Guesswork</h1>
          <p>
            A hardened file intake pipeline built for DevSecOps. Validate types,
            enforce policy, and ship with confidence.
          </p>
          <div class="hero-map-wrap">
            <div class="hero-map-head">
              <h2>Incident Pulse (Visualized)</h2>
              <small>Live Feodo/URLhaus/ThreatFox feed. GeoIP positions are approximate.</small>
            </div>
            <div id="threat-map" class="threat-map" aria-label="Threat activity map"></div>
          </div>
        </div>
        <div class="panel map-panel">
          <h2>Cyber Threat Feed (CISA KEV)</h2>
          <div class="scan-grid" id="threat-feed-list">
            <div class="scan-row"><span>Status</span><strong>Loading...</strong></div>
          </div>
          <p id="threat-feed-status" class="meta">Fetching latest known exploited vulnerabilities...</p>
        </div>
      </section>

      <section id="upload" class="upload-layout">
        <div class="panel upload">
          <h2>Upload Console</h2>
          <div class="dropzone" id="dropzone">
            <p>Drop a file here or click to choose</p>
            <label for="file-input">Choose file</label>
            <input id="file-input" type="file" />
          </div>
          <div class="meta">
            <div>Allowed types: PDF, PNG, JPG, TXT, MD, CSV, DOC(X), XLS(X), PPT(X), ODT, ODS, ODP</div>
            <div>Endpoint: <code>/upload</code></div>
          </div>
          <button class="button" id="upload-btn" type="button">Upload now</button>
          <div class="status" id="status">Waiting for input…</div>
        </div>
        <div class="panel upload">
          <h2>Virus Scanning</h2>
          <div class="scan-grid">
            <div class="scan-row"><span>File</span><strong id="scan-file">-</strong></div>
            <div class="scan-row"><span>Result</span><strong id="scan-status">No scan yet</strong></div>
            <div class="scan-row"><span>Decision</span><strong id="scan-decision">-</strong></div>
            <div class="scan-row"><span>Risk score</span><strong id="scan-risk">-</strong></div>
            <div class="scan-row"><span>Engine</span><strong id="scan-engine">-</strong></div>
            <div class="scan-row"><span>Detail</span><strong id="scan-detail">-</strong></div>
            <div class="scan-row"><span>Deduplicated</span><strong id="scan-dedup">-</strong></div>
          </div>
          <div class="meta">
            <div>Result updates after each upload.</div>
          </div>
        </div>
      </section>

      <section id="project-docs" class="panel">
        <h2>Uploaded Files</h2>
        <p>Latest uploads stored in MongoDB.</p>
        <div class="list-header">
          <span>Filename</span>
          <span>Type</span>
          <span>Status</span>
        </div>
        <div class="list" id="uploads-list">
          <div class="list-item">Loading...</div>
        </div>
        <div id="dev-docs" class="dev-only">
          <p class="meta">
            Developer API docs: <a href="/docs">/docs</a>
          </p>
          <p class="meta">
            Project docs: README.md, PLAN.md, SECURITY.md, docs/*, sre/*, runbooks/*
          </p>
        </div>
      </section>

      <section class="cards">
        <div class="card">
          <h3>Uploads (24h)</h3>
          <p id="metric-uploads-24h">-</p>
        </div>
        <div class="card">
          <h3>Rejected (24h)</h3>
          <p id="metric-rejected-24h">-</p>
        </div>
        <div class="card">
          <h3>Rejection Rate (7d)</h3>
          <p id="metric-reject-rate-7d">-</p>
        </div>
        <div class="card">
          <h3>Average Risk (7d)</h3>
          <p id="metric-risk-7d">-</p>
        </div>
      </section>

      <!-- ── Prometheus live metrics ───────────────────────────────────────── -->
      <section class="panel prometheus-section">
        <div class="prom-header">
          <h2>Live Prometheus Metrics</h2>
          <span class="prom-badge" id="prom-badge">fetching…</span>
        </div>
        <p class="meta">Pulled directly from <code>/metrics</code> · refreshes every 15 s</p>

        <div class="prom-grid">

          <!-- Uploads total gauge -->
          <div class="prom-card">
            <div class="prom-label">Total uploads</div>
            <div class="prom-value" id="prom-uploads-total">—</div>
            <svg class="prom-spark" id="spark-uploads" viewBox="0 0 120 32" preserveAspectRatio="none"></svg>
            <div class="prom-sublabel">sentinel_uploads_total (all labels)</div>
          </div>

          <!-- Rejected counter -->
          <div class="prom-card">
            <div class="prom-label">Rejected uploads</div>
            <div class="prom-value" id="prom-uploads-rejected">—</div>
            <svg class="prom-spark" id="spark-rejected" viewBox="0 0 120 32" preserveAspectRatio="none"></svg>
            <div class="prom-sublabel">sentinel_uploads_total{status="rejected"}</div>
          </div>

          <!-- Scan duration p95 -->
          <div class="prom-card">
            <div class="prom-label">Scan duration p95</div>
            <div class="prom-value" id="prom-scan-p95">—</div>
            <svg class="prom-spark" id="spark-scan" viewBox="0 0 120 32" preserveAspectRatio="none"></svg>
            <div class="prom-sublabel">sentinel_scan_duration_seconds (p95 est.)</div>
          </div>

          <!-- Risk score avg -->
          <div class="prom-card">
            <div class="prom-label">Avg risk score</div>
            <div class="prom-value" id="prom-risk-avg">—</div>
            <svg class="prom-spark" id="spark-risk" viewBox="0 0 120 32" preserveAspectRatio="none"></svg>
            <div class="prom-sublabel">sentinel_risk_score (sum/count)</div>
          </div>

        </div>
      </section>

      <!-- ── Grafana embed ──────────────────────────────────────────────────── -->
      <section class="panel grafana-section">
        <div class="prom-header">
          <h2>Grafana Dashboard</h2>
          <span class="grafana-badge">embed</span>
        </div>

        <!-- Set GRAFANA_URL to your panel URL to enable the embed.
             Example: http://grafana.example.com/d/abc123/sentinel?orgId=1&kiosk
             Leave as "" to show the placeholder. -->
        <div id="grafana-container">
          <div class="grafana-placeholder" id="grafana-placeholder">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2">
              <rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/>
              <path d="M7 8h2v5H7zM11 10h2v3h-2zM15 6h2v7h-2z"/>
            </svg>
            <p>Grafana not configured</p>
            <p class="meta">Set <code>GRAFANA_URL</code> in the script below to embed a live panel.</p>
            <a class="button" href="https://grafana.com/docs/grafana/latest/panels-visualizations/share-panels-dashboards/" target="_blank" rel="noopener">Grafana embed docs ↗</a>
          </div>
          <iframe id="grafana-frame" class="grafana-frame" src="" title="Grafana dashboard" allowfullscreen style="display:none"></iframe>
        </div>
      </section>

      <footer>
        <p>Sentinel Upload API · NordTech AB · DevSecOps program</p>
      </footer>
    </main>

    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script>
      const threatFeedStatusEl = document.getElementById("threat-feed-status");
      const threatFeedListEl = document.getElementById("threat-feed-list");
      const threatMapEl = document.getElementById("threat-map");
      let threatMap = null;
      let threatMapLayer = null;

      const dropzone = document.getElementById("dropzone");
      const input = document.getElementById("file-input");
      const uploadBtn = document.getElementById("upload-btn");
      const statusEl = document.getElementById("status");
      const scanFileEl = document.getElementById("scan-file");
      const scanStatusEl = document.getElementById("scan-status");
      const scanDecisionEl = document.getElementById("scan-decision");
      const scanRiskEl = document.getElementById("scan-risk");
      const scanEngineEl = document.getElementById("scan-engine");
      const scanDetailEl = document.getElementById("scan-detail");
      const scanDedupEl = document.getElementById("scan-dedup");
      const devDocsEl = document.getElementById("dev-docs");
      const metricUploads24hEl = document.getElementById("metric-uploads-24h");
      const metricRejected24hEl = document.getElementById("metric-rejected-24h");
      const metricRejectRate7dEl = document.getElementById("metric-reject-rate-7d");
      const metricRisk7dEl = document.getElementById("metric-risk-7d");

      const isDevHost =
        window.location.hostname === "localhost" ||
        window.location.hostname === "127.0.0.1" ||
        window.location.hostname === "[::1]";
      if (isDevHost && devDocsEl) {
        devDocsEl.classList.add("is-visible");
      }
      function setStatus(message, type) {
        statusEl.textContent = message;
        statusEl.classList.remove("error", "warn");
        if (type) statusEl.classList.add(type);
      }

      function setScanResult(data) {
        scanFileEl.textContent = data.filename || "-";
        scanStatusEl.textContent = data.scan_status || "unknown";
        scanDecisionEl.textContent = data.decision || "-";
        scanRiskEl.textContent =
          typeof data.risk_score === "number" ? `${data.risk_score}/100` : "-";
        scanEngineEl.textContent = data.scan_engine || "-";
        scanDetailEl.textContent = data.scan_detail || "-";
        scanDedupEl.textContent = data.deduplicated ? "Yes" : "No";

        scanStatusEl.classList.remove("status-clean", "status-malicious", "status-error");
        scanDecisionEl.classList.remove("status-clean", "status-malicious", "status-review");

        if (data.scan_status === "clean") {
          scanStatusEl.classList.add("status-clean");
        } else if (data.scan_status === "malicious") {
          scanStatusEl.classList.add("status-malicious");
        } else {
          scanStatusEl.classList.add("status-error");
        }

        if (data.decision === "accepted") {
          scanDecisionEl.classList.add("status-clean");
        } else if (data.decision === "rejected") {
          scanDecisionEl.classList.add("status-malicious");
        } else if (data.decision === "review") {
          scanDecisionEl.classList.add("status-review");
        }
      }

      function setMetrics(data) {
        if (!data) return;
        const last24h = data.last_24h || {};
        const last7d = data.last_7d || {};
        metricUploads24hEl.textContent = `${last24h.total_uploads ?? 0}`;
        metricRejected24hEl.textContent = `${last24h.rejected ?? 0}`;
        metricRejectRate7dEl.textContent = `${last7d.rejection_rate_percent ?? 0}%`;
        metricRisk7dEl.textContent = `${last7d.avg_risk_score ?? 0}/100`;
      }

      function detailRow(label, value, valueClass) {
        const row = document.createElement("div");
        row.className = "scan-row";
        const labelEl = document.createElement("span");
        labelEl.textContent = label;
        const valueEl = document.createElement("strong");
        valueEl.textContent = value;
        if (valueClass) valueEl.classList.add(valueClass);
        row.appendChild(labelEl);
        row.appendChild(valueEl);
        return row;
      }

      function renderThreatFeed(payload) {
        if (!threatFeedListEl) return;
        const latest = payload.latest || [];
        threatFeedListEl.innerHTML = "";

        const summaryRows = [
          ["Source", payload.source || "CISA KEV"],
          ["Total KEV", String(payload.total_known_exploited_cves ?? 0)],
          ["Added 30d", String(payload.added_last_30_days ?? 0)],
        ];
        summaryRows.forEach(([label, value]) => {
          const row = document.createElement("div");
          row.className = "scan-row";
          row.innerHTML = `<span>${label}</span><strong>${value}</strong>`;
          threatFeedListEl.appendChild(row);
        });

        latest.slice(0, 5).forEach((item) => {
          const row = document.createElement("div");
          row.className = "scan-row";
          row.innerHTML = `<span>${item.cve || "CVE"}</span><strong>${item.vendor || ""} ${item.product || ""} (${item.date_added || ""})</strong>`;
          threatFeedListEl.appendChild(row);
        });

        threatFeedStatusEl.textContent = `Updated ${payload.fetched_at || "recently"} via ${payload.source || "CISA KEV"}.`;
        if (payload.warning) {
          threatFeedStatusEl.textContent = payload.warning;
        }
      }

      function initThreatMap() {
        if (!threatMapEl || typeof L === "undefined") return;
        const worldBounds = L.latLngBounds(
          L.latLng(-85, -180),
          L.latLng(85, 180),
        );
        threatMap = L.map("threat-map", {
          zoomControl: false,
          attributionControl: true,
          minZoom: 1,
          maxZoom: 8,
          maxBounds: worldBounds,
          maxBoundsViscosity: 1.0,
        }).setView([20, 0], 2);
        L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
          maxZoom: 8,
          subdomains: "abcd",
          noWrap: true,
          attribution: "&copy; OpenStreetMap contributors &copy; CARTO",
        }).addTo(threatMap);
        if (typeof L.markerClusterGroup === "function") {
          threatMapLayer = L.markerClusterGroup({
            showCoverageOnHover: false,
            spiderfyOnMaxZoom: true,
            maxClusterRadius: 42,
          });
          threatMap.addLayer(threatMapLayer);
        } else {
          threatMapLayer = L.layerGroup().addTo(threatMap);
        }
      }

      function renderThreatMap(events) {
        if (!threatMap || !threatMapLayer) return;
        threatMapLayer.clearLayers();
        const points = [];
        const coordBuckets = new Map();
        (events || []).forEach((item) => {
          const lat = Number(item.lat);
          const lon = Number(item.lon);
          if (!Number.isFinite(lat) || !Number.isFinite(lon)) return;

          const severity = (item.severity || "").toLowerCase();
          const size = severity === "high" ? 8 : severity === "medium" ? 7 : 6;
          const bucketKey = `${lat.toFixed(4)},${lon.toFixed(4)}`;
          const bucketIndex = coordBuckets.get(bucketKey) || 0;
          coordBuckets.set(bucketKey, bucketIndex + 1);

          // If several events share identical coordinates, fan them out slightly
          // so all markers become visible instead of stacking as one.
          const angle = bucketIndex * (Math.PI / 4);
          const radius = Math.floor(bucketIndex / 8) * 0.18 + (bucketIndex > 0 ? 0.12 : 0);
          const markerLat = lat + radius * Math.sin(angle);
          const markerLon = lon + radius * Math.cos(angle);

          const icon = L.divIcon({
            className: "threat-dot",
            iconSize: [size, size],
            iconAnchor: [Math.floor(size / 2), Math.floor(size / 2)],
          });
          const marker = L.marker([markerLat, markerLon], { icon, title: item.ioc || item.type || "Threat event" }).addTo(threatMapLayer);
          marker.bindPopup(
            `<strong>${item.type || "Threat event"}</strong><br>` +
            `${item.ioc || ""}<br>` +
            `${item.details?.city || ""} ${item.details?.country ? `(${item.details.country})` : ""}<br>` +
            `${item.details?.malware_family ? `Malware: ${item.details.malware_family}<br>` : ""}` +
            `${item.details?.status ? `Status: ${item.details.status}<br>` : ""}` +
            `${typeof item.confidence === "number" ? `Confidence: ${item.confidence}%<br>` : ""}` +
            `${item.source || ""}<br>` +
            `${item.timestamp || ""}`
          );
          points.push([markerLat, markerLon]);
        });
        if (points.length > 1) {
          threatMap.fitBounds(points, { padding: [20, 20], maxZoom: 6 });
        }
      }

      dropzone.addEventListener("dragover", (event) => {
        event.preventDefault();
        dropzone.classList.add("dragover");
      });

      dropzone.addEventListener("dragleave", () => {
        dropzone.classList.remove("dragover");
      });

      dropzone.addEventListener("drop", (event) => {
        event.preventDefault();
        dropzone.classList.remove("dragover");
        if (event.dataTransfer.files.length) {
          input.files = event.dataTransfer.files;
          setStatus(`Selected ${input.files[0].name}`);
        }
      });

      // Avoid double file-picker dialogs on browsers that already trigger via <label for>.
      dropzone.addEventListener("click", (event) => {
        const target = event.target;
        const isLabelOrInput =
          target instanceof HTMLElement &&
          (target.tagName === "LABEL" || target.tagName === "INPUT");
        if (isLabelOrInput) return;
        input.click();
      });

      // Allow selecting the same file again after a previous upload.
      input.addEventListener("click", () => {
        input.value = "";
      });
      input.addEventListener("change", () => {
        if (input.files.length) {
          setStatus(`Selected ${input.files[0].name}`);
        }
      });

      async function loadUploads() {
        try {
          const response = await fetch("/uploads?limit=25");
          if (!response.ok) {
            if (response.status === 401) {
              throw new Error("Auth required");
            }
            throw new Error("Database unavailable");
          }
          const data = await response.json();
          const list = document.getElementById("uploads-list");
          list.innerHTML = "";
          if (!data.items.length) {
            list.innerHTML = '<div class="list-item">No uploads yet</div>';
            return;
          }
          data.items.forEach((item) => {
            const wrapper = document.createElement("div");
            wrapper.className = "upload-item";

            const row = document.createElement("div");
            row.className = "list-item list-item-toggle";
            row.setAttribute("role", "button");
            row.setAttribute("tabindex", "0");
            row.setAttribute("aria-expanded", "false");
            row.title = "Click to show scan details";
            const nameSpan = document.createElement("span");
            nameSpan.textContent = item.filename;
            const typeSpan = document.createElement("span");
            typeSpan.textContent = item.content_type;
            const statusSpan = document.createElement("span");
            statusSpan.textContent = item.status;
            if (item.status === "rejected") {
              statusSpan.classList.add("status-malicious");
            } else if (item.status === "accepted") {
              statusSpan.classList.add("status-clean");
            } else {
              statusSpan.classList.add("status-review");
            }
            row.appendChild(nameSpan);
            row.appendChild(typeSpan);
            row.appendChild(statusSpan);

            const details = document.createElement("div");
            details.className = "upload-details";
            details.hidden = true;
            details.style.display = "none";
            details.appendChild(detailRow("Result", item.scan_status || "unknown"));
            details.appendChild(detailRow("Decision", item.decision || "-", item.decision === "rejected" ? "status-malicious" : item.decision === "accepted" ? "status-clean" : "status-review"));
            details.appendChild(detailRow("Risk score", typeof item.risk_score === "number" ? `${item.risk_score}/100` : "-"));
            details.appendChild(detailRow("Engine", item.scan_engine || "-"));
            details.appendChild(detailRow("Detail", item.scan_detail || "-"));
            details.appendChild(detailRow("Deduplicated", item.deduplicated ? "Yes" : "No"));
            details.appendChild(detailRow("SHA-256", item.sha256 || "-"));

            const toggleDetails = () => {
              const isOpen = wrapper.classList.toggle("is-open");
              details.hidden = !isOpen;
              details.style.display = isOpen ? "grid" : "none";
              row.setAttribute("aria-expanded", isOpen ? "true" : "false");
              // Keep the side panel in sync with selected row.
              setScanResult(item);
            };
            row.addEventListener("click", toggleDetails);
            row.addEventListener("keydown", (event) => {
              if (event.key === "Enter" || event.key === " ") {
                event.preventDefault();
                toggleDetails();
              }
            });

            wrapper.appendChild(row);
            wrapper.appendChild(details);
            list.appendChild(wrapper);
          });
        } catch (error) {
          const list = document.getElementById("uploads-list");
          list.innerHTML = `<div class="list-item">${error.message}</div>`;
        }
      }

      async function loadMetrics() {
        try {
          const response = await fetch("/metrics/summary");
          if (!response.ok) {
            throw new Error("Metrics unavailable");
          }
          const data = await response.json();
          setMetrics(data);
        } catch (_error) {
          metricUploads24hEl.textContent = "-";
          metricRejected24hEl.textContent = "-";
          metricRejectRate7dEl.textContent = "-";
          metricRisk7dEl.textContent = "-";
        }
      }

      async function loadThreatFeed() {
        try {
          const response = await fetch("/external/threats/kev-summary");
          if (!response.ok) {
            throw new Error("Threat feed unavailable");
          }
          const data = await response.json();
          renderThreatFeed(data);
        } catch (_error) {
          if (threatFeedStatusEl) {
            threatFeedStatusEl.textContent = "Unable to load threat feed right now.";
          }
        }
      }

      async function loadThreatMapEvents() {
        try {
          const response = await fetch("/api/v1/threats/?limit=200");
          if (!response.ok) {
            throw new Error("Threat map data unavailable");
          }
          const events = await response.json();
          renderThreatMap(events);
        } catch (_error) {
          if (threatMapLayer) {
            threatMapLayer.clearLayers();
          }
        }
      }

      uploadBtn.addEventListener("click", async () => {
        if (!input.files.length) {
          setStatus("Choose a file first.", "warn");
          return;
        }

        const formData = new FormData();
        formData.append("file", input.files[0]);

        try {
          setStatus("Uploading...");
          const response = await fetch("/upload", {
            method: "POST",
            body: formData,
          });
          const data = await response.json();
          if (!response.ok) {
            throw new Error(data.detail || "Upload failed");
          }
          setStatus(`Accepted: ${data.filename} (${data.content_type})`);
          setScanResult(data);
          await loadUploads();
          await loadMetrics();
        } catch (error) {
          setStatus(error.message, "error");
        }
      });

      loadUploads();
      loadMetrics();
      initThreatMap();
      loadThreatFeed();
      loadThreatMapEvents();
      setInterval(() => {
        loadThreatFeed();
        loadThreatMapEvents();
      }, 60000);
    </script>
    <a
  class="bug-fab"
  href="https://github.com/Sidestep-Error/sentinel-upload-api/issues/new/choose"
  target="_blank"
  rel="noopener noreferrer"
  aria-label="Report a bug"
>
  Report bug
</a>

<style>
/* ── Prometheus section ──────────────────────────────────────────────────── */
.prometheus-section {
  margin-top: 2rem;
}
.prom-header {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-bottom: 0.25rem;
}
.prom-badge {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.7rem;
  padding: 0.2rem 0.55rem;
  border-radius: 999px;
  background: rgba(99,255,180,0.12);
  color: #63ffb4;
  border: 1px solid rgba(99,255,180,0.25);
  letter-spacing: 0.04em;
}
.prom-badge.error {
  background: rgba(255,80,80,0.12);
  color: #ff6b6b;
  border-color: rgba(255,80,80,0.25);
}
.prom-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 1rem;
  margin-top: 1.25rem;
}
.prom-card {
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 10px;
  padding: 1rem 1.1rem 0.75rem;
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
  transition: border-color 0.2s;
}
.prom-card:hover {
  border-color: rgba(99,255,180,0.22);
}
.prom-label {
  font-size: 0.72rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: rgba(255,255,255,0.45);
}
.prom-value {
  font-family: 'JetBrains Mono', monospace;
  font-size: 1.65rem;
  font-weight: 600;
  color: #e8f0ff;
  line-height: 1.1;
}
.prom-spark {
  width: 100%;
  height: 32px;
  margin: 0.3rem 0 0.1rem;
  overflow: visible;
}
.prom-sublabel {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.62rem;
  color: rgba(255,255,255,0.28);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* ── Grafana section ─────────────────────────────────────────────────────── */
.grafana-section {
  margin-top: 2rem;
}
.grafana-badge {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.7rem;
  padding: 0.2rem 0.55rem;
  border-radius: 999px;
  background: rgba(255,166,0,0.12);
  color: #ffb347;
  border: 1px solid rgba(255,166,0,0.25);
  letter-spacing: 0.04em;
}
.grafana-placeholder {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 0.6rem;
  padding: 3rem 1rem;
  border: 1px dashed rgba(255,255,255,0.12);
  border-radius: 10px;
  margin-top: 1rem;
  color: rgba(255,255,255,0.35);
  text-align: center;
}
.grafana-placeholder svg {
  opacity: 0.35;
}
.grafana-placeholder p {
  margin: 0;
  font-size: 0.95rem;
}
.grafana-frame {
  width: 100%;
  height: 480px;
  border: none;
  border-radius: 10px;
  margin-top: 1rem;
  background: #111;
}
</style>

<script>
// ── Grafana config ────────────────────────────────────────────────────────
// Paste your Grafana panel/dashboard URL here to enable the embed.
// Append ?kiosk or &kiosk to the URL for fullscreen kiosk mode.
// Example: "http://grafana.example.com/d/abc123/sentinel?orgId=1&kiosk"
const GRAFANA_URL = "";

(function initGrafana() {
  if (!GRAFANA_URL) return;
  const frame = document.getElementById("grafana-frame");
  const placeholder = document.getElementById("grafana-placeholder");
  if (!frame || !placeholder) return;
  frame.src = GRAFANA_URL;
  frame.style.display = "block";
  placeholder.style.display = "none";
})();

// ── Prometheus metrics ────────────────────────────────────────────────────
// Spark-line history — keeps last N samples per metric
const SPARK_MAX = 20;
const sparkHistory = {
  uploads:  [],
  rejected: [],
  scan:     [],
  risk:     [],
};

function parsePrometheusText(text) {
  const result = {};
  for (const line of text.split("\n")) {
    if (line.startsWith("#") || !line.trim()) continue;
    // Match: metric_name{labels} value  OR  metric_name value
    const m = line.match(/^([a-zA-Z_:][a-zA-Z0-9_:]*(?:\{[^}]*\})?) +([0-9.eE+\-]+|NaN|Inf|-Inf)/);
    if (!m) continue;
    const key = m[1];
    const val = parseFloat(m[2]);
    if (!isNaN(val)) result[key] = val;
  }
  return result;
}

function sumByPrefix(parsed, prefix) {
  return Object.entries(parsed)
    .filter(([k]) => k.startsWith(prefix))
    .reduce((acc, [, v]) => acc + v, 0);
}

function getLabel(parsed, metric, labelKey, labelVal) {
  // Find a metric line that has a specific label value
  const target = `${metric}{`;
  for (const [k, v] of Object.entries(parsed)) {
    if (!k.startsWith(target)) continue;
    if (k.includes(`${labelKey}="${labelVal}"`)) return v;
  }
  return 0;
}

function estimateP95(parsed, baseName) {
  // Use the highest bucket below +Inf to estimate p95
  // sentinel_scan_duration_seconds_bucket{le="X"}
  const buckets = [];
  for (const [k, v] of Object.entries(parsed)) {
    if (!k.startsWith(`${baseName}_bucket`)) continue;
    const leM = k.match(/le="([^"]+)"/);
    if (!leM) continue;
    const le = parseFloat(leM[1]);
    if (!isFinite(le)) continue;
    buckets.push({ le, count: v });
  }
  if (!buckets.length) return null;
  buckets.sort((a, b) => a.le - b.le);
  const total = parsed[`${baseName}_count`] || 0;
  if (!total) return null;
  const p95target = total * 0.95;
  for (const b of buckets) {
    if (b.count >= p95target) return b.le;
  }
  return buckets[buckets.length - 1].le;
}

function drawSparkline(svgId, history, color = "#63ffb4") {
  const svg = document.getElementById(svgId);
  if (!svg || history.length < 2) return;
  svg.innerHTML = "";
  const W = 120, H = 28;
  const min = Math.min(...history);
  const max = Math.max(...history);
  const range = max - min || 1;
  const pts = history.map((v, i) => {
    const x = (i / (history.length - 1)) * W;
    const y = H - ((v - min) / range) * H;
    return `${x.toFixed(1)},${y.toFixed(1)}`;
  });
  // Area fill
  const area = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
  area.setAttribute("points", `0,${H} ` + pts.join(" ") + ` ${W},${H}`);
  area.setAttribute("fill", color.replace(")", ",0.12)").replace("rgb", "rgba").replace("#63ffb4", "rgba(99,255,180,0.10)"));
  area.setAttribute("stroke", "none");
  svg.appendChild(area);
  // Line
  const line = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
  line.setAttribute("points", pts.join(" "));
  line.setAttribute("fill", "none");
  line.setAttribute("stroke", color);
  line.setAttribute("stroke-width", "1.5");
  line.setAttribute("stroke-linejoin", "round");
  line.setAttribute("stroke-linecap", "round");
  svg.appendChild(line);
  // Last dot
  const last = pts[pts.length - 1].split(",");
  const dot = document.createElementNS("http://www.w3.org/2000/svg", "circle");
  dot.setAttribute("cx", last[0]);
  dot.setAttribute("cy", last[1]);
  dot.setAttribute("r", "2.5");
  dot.setAttribute("fill", color);
  svg.appendChild(dot);
}

function pushHistory(arr, val) {
  arr.push(val);
  if (arr.length > SPARK_MAX) arr.shift();
}

async function loadPrometheusMetrics() {
  const badge = document.getElementById("prom-badge");
  try {
    const res = await fetch("/metrics");
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const text = await res.text();
    const parsed = parsePrometheusText(text);

    // ── uploads total ────────────────────────────────────────────────────
    const uploadsTotal = sumByPrefix(parsed, "sentinel_uploads_total{");
    const uploadsFallback = parsed["sentinel_uploads_total"] || 0;
    const uploads = uploadsTotal || uploadsFallback;
    document.getElementById("prom-uploads-total").textContent =
      uploads > 0 ? uploads.toFixed(0) : "0";
    pushHistory(sparkHistory.uploads, uploads);
    drawSparkline("spark-uploads", sparkHistory.uploads, "#63ffb4");

    // ── rejected ─────────────────────────────────────────────────────────
    const rejected = getLabel(parsed, "sentinel_uploads_total", "status", "rejected");
    document.getElementById("prom-uploads-rejected").textContent =
      rejected > 0 ? rejected.toFixed(0) : "0";
    pushHistory(sparkHistory.rejected, rejected);
    drawSparkline("spark-rejected", sparkHistory.rejected, "#ff6b6b");

    // ── scan duration p95 ────────────────────────────────────────────────
    const p95 = estimateP95(parsed, "sentinel_scan_duration_seconds");
    document.getElementById("prom-scan-p95").textContent =
      p95 !== null ? `${p95 * 1000 < 1000 ? (p95 * 1000).toFixed(0) + " ms" : p95.toFixed(2) + " s"}` : "—";
    pushHistory(sparkHistory.scan, p95 || 0);
    drawSparkline("spark-scan", sparkHistory.scan, "#a78bfa");

    // ── risk score avg ───────────────────────────────────────────────────
    const riskSum   = parsed["sentinel_risk_score_sum"]   || 0;
    const riskCount = parsed["sentinel_risk_score_count"] || 0;
    const riskAvg   = riskCount > 0 ? riskSum / riskCount : 0;
    document.getElementById("prom-risk-avg").textContent =
      riskCount > 0 ? riskAvg.toFixed(1) : "—";
    pushHistory(sparkHistory.risk, riskAvg);
    drawSparkline("spark-risk", sparkHistory.risk, "#fbbf24");

    // ── badge ────────────────────────────────────────────────────────────
    const now = new Date();
    badge.textContent = `updated ${now.toLocaleTimeString()}`;
    badge.classList.remove("error");

  } catch (err) {
    badge.textContent = "unavailable";
    badge.classList.add("error");
  }
}

// Initial load + refresh every 15 s
loadPrometheusMetrics();
setInterval(loadPrometheusMetrics, 15000);
</script>

  </body>
</html>
